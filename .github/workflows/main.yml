name: Deploy Proxmox VE via Tailscale

on:
  workflow_dispatch:
    inputs:
      node_name:
        description: 'Proxmox Node Name'
        required: true
        default: 'proxmox-tailscale-01'
      tailscale_auth_key:
        description: 'Tailscale Auth Key'
        required: true
        type: string

jobs:
  deploy-proxmox-tailscale:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Tailscale
      run: |
        echo "ðŸ”§ Setting up Tailscale..."
        
        # Install Tailscale
        curl -fsSL https://tailscale.com/install.sh | sh
        
        # Start Tailscale
        sudo tailscale up --auth-key=${{ github.event.inputs.tailscale_auth_key }} --hostname=proxmox-deploy-${{ github.event.inputs.node_name }}
        
        # Get Tailscale IP
        TS_IP=$(tailscale ip -4)
        echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
        echo "ðŸŒ Tailscale IP: $TS_IP"
        
        # Wait for network to stabilize
        sleep 10

    - name: Create Proxmox Installation Script for Tailscale
      run: |
        cat > install-proxmox-tailscale.sh << 'EOF'
        #!/bin/bash
        
        echo "ðŸŽ¯ Starting Proxmox VE Installation via Tailscale..."
        
        # Set variables
        NODE_NAME="$1"
        TAILSCALE_IP="$2"
        
        # Update system
        apt-get update && apt-get upgrade -y
        
        # Add Proxmox repository
        echo "deb [arch=amd64] http://download.proxmox.com/debian/pve bookworm pve-no-subscription" > /etc/apt/sources.list.d/pve-install-repo.list
        
        # Add Proxmox key
        wget -O /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg http://download.proxmox.com/debian/proxmox-release-bookworm.gpg
        
        # Update and install Proxmox
        apt-get update
        apt-get install -y proxmox-ve postfix open-iscsi
        
        # Remove subscription warning
        sed -i 's/data.status !== "Active"/false/g' /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
        
        # Configure hostname
        echo "$NODE_NAME" > /etc/hostname
        sed -i "s/127.0.1.1.*/127.0.1.1\t$NODE_NAME/g" /etc/hosts
        
        # Configure Proxmox to use Tailscale IP
        cat >> /etc/hosts << HOSTS_EOF
        
        # Tailscale configuration
        $TAILSCALE_IP $NODE_NAME $NODE_NAME.tailscale
        HOSTS_EOF
        
        echo "âœ… Proxmox VE installation completed for Tailscale"
        EOF
        
        chmod +x install-proxmox-tailscale.sh

    - name: Create Tailscale Network Configuration
      run: |
        cat > configure-tailscale-network.sh << 'EOF'
        #!/bin/bash
        
        echo "ðŸŒ Configuring Network for Tailscale..."
        
        TAILSCALE_IP="$1"
        NODE_NAME="$2"
        
        # Get the main network interface
        INTERFACE=$(ip route show default | awk '/default/ {print $5}' | head -1)
        
        # Backup original network config
        cp /etc/network/interfaces /etc/network/interfaces.backup
        
        # Configure network for Proxmox with Tailscale
        cat > /etc/network/interfaces << NETWORK_EOF
        auto lo
        iface lo inet loopback
        
        auto $INTERFACE
        iface $INTERFACE inet dhcp
        
        # Tailscale interface (auto-configured)
        # Proxmox bridge for VMs - using private network
        auto vmbr0
        iface vmbr0 inet static
            address 10.10.10.1
            netmask 255.255.255.0
            bridge_ports none
            bridge_stp off
            bridge_fd 0
            
        # Optional: Bridge for Tailscale if needed
        auto vmbr1
        iface vmbr1 inet static
            address 100.64.0.1
            netmask 255.192.0.0
            bridge_ports none
            bridge_stp off
            bridge_fd 0
        NETWORK_EOF
        
        # Configure Proxmox web interface to listen on Tailscale IP
        sed -i "s/^[[:space:]]*address.*/address: $TAILSCALE_IP/" /etc/pve/local/config
        sed -i "s/^[[:space:]]*hostname.*/hostname: $NODE_NAME/" /etc/pve/local/config
        
        echo "âœ… Tailscale network configuration completed"
        EOF
        
        chmod +x configure-tailscale-network.sh

    - name: Create Proxmox Web Configuration for Tailscale
      run: |
        cat > configure-proxmox-web.sh << 'EOF'
        #!/bin/bash
        
        echo "ðŸ–¥ï¸ Configuring Proxmox Web Interface for Tailscale..."
        
        TAILSCALE_IP="$1"
        NODE_NAME="$2"
        
        # Ensure Proxmox services are running
        systemctl enable pveproxy
        systemctl enable pvedaemon
        systemctl enable pvestatd
        
        systemctl start pveproxy
        systemctl start pvedaemon
        systemctl start pvestatd
        
        # Configure firewall for Tailscale access
        iptables -I INPUT -p tcp --dport 8006 -j ACCEPT
        iptables -I INPUT -p tcp --dport 22 -j ACCEPT
        iptables -I INPUT -p tcp --dport 5900:5999 -j ACCEPT  # VNC
        iptables -I INPUT -p tcp --dport 3128 -j ACCEPT       # SPICE
        
        # Save iptables rules
        apt-get install -y iptables-persistent
        netfilter-persistent save
        
        # Configure Proxmox to accept connections from Tailscale
        systemctl restart pveproxy
        
        echo "âœ… Web interface configured: https://$TAILSCALE_IP:8006"
        echo "ðŸŒ Access via Tailscale network only"
        EOF
        
        chmod +x configure-proxmox-web.sh

    - name: Create Tailscale VM Deployment Script
      run: |
        cat > deploy-vm-tailscale.sh << 'EOF'
        #!/bin/bash
        
        echo "ðŸ–¥ï¸ Deploying VM with Tailscale access..."
        
        VM_ID="$1"
        VM_NAME="$2"
        TAILSCALE_IP="$3"
        
        # Example command to create a VM with Tailscale network access
        echo "Creating VM $VM_NAME (ID: $VM_ID) with Tailscale access"
        
        # Command template for VM creation
        cat > create_vm_$VM_ID.sh << VM_EOF
        #!/bin/bash
        pvesh create /nodes/\\$(hostname)/qemu \\
          --vmid $VM_ID \\
          --name "$VM_NAME" \\
          --memory 2048 \\
          --cores 2 \\
          --net0 virtio,bridge=vmbr0 \\
          --scsihw virtio-scsi-pci \\
          --scsi0 local-lvm:32 \\
          --boot order=scsi0 \\
          --description "VM deployed via Tailscale - Access via $TAILSCALE_IP"
        
        echo "VM $VM_NAME created with ID $VM_ID"
        echo "Access via Proxmox: https://$TAILSCALE_IP:8006"
        VM_EOF
        
        chmod +x create_vm_$VM_ID.sh
        echo "âœ… VM deployment script created: create_vm_$VM_ID.sh"
        EOF
        
        chmod +x deploy-vm-tailscale.sh

    - name: Create SSL Certificate for Tailscale
      run: |
        cat > generate-tailscale-ssl.sh << 'EOF'
        #!/bin/bash
        
        echo "ðŸ” Generating SSL Certificate for Tailscale..."
        
        TAILSCALE_IP="$1"
        NODE_NAME="$2"
        
        # Create certificate directory
        mkdir -p /etc/pve/local/pve-ssl
        
        # Generate certificate for Tailscale IP
        openssl req -newkey rsa:2048 -nodes -keyout /etc/pve/local/pve-ssl/pve-ssl.key \\
          -x509 -days 365 -out /etc/pve/local/pve-ssl/pve-ssl.pem \\
          -subj "/CN=$NODE_NAME" \\
          -addext "subjectAltName=IP:$TAILSCALE_IP,DNS:$NODE_NAME.tailscale"
        
        # Restart Proxmox services
        systemctl restart pveproxy
        systemctl restart pvedaemon
        
        echo "âœ… SSL certificate generated for Tailscale IP: $TAILSCALE_IP"
        EOF
        
        chmod +x generate-tailscale-ssl.sh

    - name: Create Deployment Guide
      run: |
        cat > TAILSCALE_PROXMOX_GUIDE.md << EOF
        # Proxmox VE Deployment via Tailscale
        
        ## ðŸ“‹ Overview
        Proxmox Virtual Environment deployed with Tailscale for secure remote access.
        
        ## ðŸŒ Tailscale Configuration
        - **Node Name**: ${{ github.event.inputs.node_name }}
        - **Tailscale IP**: ${{ env.TAILSCALE_IP }}
        - **Access URL**: https://${{ env.TAILSCALE_IP }}:8006
        
        ## ðŸ”§ Installation Steps
        
        1. **Transfer scripts to your server:**
           \`\`\`bash
           scp *.sh root@your-server:/root/
           \`\`\`
        
        2. **Make scripts executable:**
           \`\`\`bash
           chmod +x *.sh
           \`\`\`
        
        3. **Install Proxmox:**
           \`\`\`bash
           ./install-proxmox-tailscale.sh ${{ github.event.inputs.node_name }} ${{ env.TAILSCALE_IP }}
           \`\`\`
        
        4. **Configure network:**
           \`\`\`bash
           ./configure-tailscale-network.sh ${{ env.TAILSCALE_IP }} ${{ github.event.inputs.node_name }}
           \`\`\`
        
        5. **Configure web interface:**
           \`\`\`bash
           ./configure-proxmox-web.sh ${{ env.TAILSCALE_IP }} ${{ github.event.inputs.node_name }}
           \`\`\`
        
        6. **Generate SSL certificate:**
           \`\`\`bash
           ./generate-tailscale-ssl.sh ${{ env.TAILSCALE_IP }} ${{ github.event.inputs.node_name }}
           \`\`\`
        
        ## ðŸ”’ Security Features
        - âœ… Encrypted Tailscale connection
        - âœ… SSL certificates for web interface
        - âœ… Private VM network (10.10.10.0/24)
        - âœ… Tailscale-only access
        
        ## ðŸŒ Network Architecture
        \`\`\`
        Internet â†’ Tailscale Network â†’ Proxmox VE
                         â”‚
                         â”œâ”€â”€ VM Network: 10.10.10.0/24
                         â”œâ”€â”€ Tailscale Access: ${{ env.TAILSCALE_IP }}:8006
                         â””â”€â”€ Secure Web Interface
        \`\`\`
        
        ## ðŸš€ Access Instructions
        1. Ensure you're connected to Tailscale
        2. Open browser: https://${{ env.TAILSCALE_IP }}:8006
        3. Login with root credentials
        
        ## ðŸ“ž Support
        - Tailscale status: \`tailscale status\`
        - Proxmox services: \`systemctl status pveproxy\`
        - Network: \`ip addr show\`
        EOF

    - name: Display Deployment Information
      run: |
        echo ""
        echo "================================================"
        echo "ðŸš€ PROXMOX VE VIA TAILSCALE - DEPLOYMENT READY"
        echo "================================================"
        echo "ðŸ“‹ Node Name: ${{ github.event.inputs.node_name }}"
        echo "ðŸŒ Tailscale IP: ${{ env.TAILSCALE_IP }}"
        echo "ðŸ”— Access URL: https://${{ env.TAILSCALE_IP }}:8006"
        echo "================================================"
        echo "ðŸ“¦ Generated Scripts:"
        echo "   - install-proxmox-tailscale.sh"
        echo "   - configure-tailscale-network.sh"
        echo "   - configure-proxmox-web.sh"
        echo "   - deploy-vm-tailscale.sh"
        echo "   - generate-tailscale-ssl.sh"
        echo "================================================"
        echo "ðŸ”’ Security Features:"
        echo "   - Tailscale-encrypted connection"
        echo "   - Private VM network"
        echo "   - SSL-secured web interface"
        echo "================================================"
        echo "ðŸ“– Guide: TAILSCALE_PROXMOX_GUIDE.md"
        echo "================================================"

    - name: Upload Deployment Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: proxmox-tailscale-scripts
        path: |
          *.sh
          TAILSCALE_PROXMOX_GUIDE.md
        retention-days: 30

    - name: Final Tailscale Deployment Summary
      run: |
        echo ""
        echo "ðŸŽ‰ PROXMOX VE TAILSCALE DEPLOYMENT COMPLETE"
        echo "================================================"
        echo "ðŸŒ Access Information:"
        echo "   URL: https://${{ env.TAILSCALE_IP }}:8006"
        echo "   Node: ${{ github.event.inputs.node_name }}"
        echo "   Network: Tailscale Encrypted"
        echo ""
        echo "ðŸ“¦ Next Steps:"
        echo "   1. Download scripts from Actions Artifacts"
        echo "   2. Transfer to your Proxmox server"
        echo "   3. Run scripts in order (see guide)"
        echo "   4. Access via Tailscale network only"
        echo ""
        echo "ðŸ”’ Security Note:"
        echo "   - Only Tailscale-connected devices can access"
        echo "   - No public internet exposure"
        echo "   - Encrypted end-to-end connection"
        echo "================================================"
        echo ""
        echo "ðŸ’¡ Pro Tip:"
        echo "   Use Tailscale ACLs to control access to your Proxmox node"
        echo "   from the Tailscale admin console."

  # Optional: Automated deployment to a cloud server
  deploy-to-cloud:
    runs-on: ubuntu-latest
    needs: deploy-proxmox-tailscale
    if: false  # Set to true if you want to auto-deploy to cloud
    
    steps:
    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        name: proxmox-tailscale-scripts
        
    - name: Display Cloud Deployment Info
      run: |
        echo "â˜ï¸  Cloud deployment would be triggered here"
        echo "Target: Your cloud server with Tailscale"
        echo "Scripts are ready in the artifacts"
