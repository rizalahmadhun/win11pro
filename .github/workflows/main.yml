name: RDP Windows 11 Pro

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Configure System Display Information
        run: |
          # Script untuk mengubah beberapa informasi tampilan sistem (visual only)
          Write-Host "Configuring system display information..."
          
          # Mengubah nama device (temporary)
          $newName = "WIN11-PRO-RDP"
          Write-Host "Setting computer name to: $newName"
          
          # Registry edits untuk mengubah tampilan sistem (hati-hati)
          # Ini hanya mengubah tampilan, bukan spesifikasi sebenarnya
          New-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion" -Name "ProductName" -Value "Windows 11 Pro" -PropertyType String -Force -ErrorAction SilentlyContinue
          New-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion" -Name "EditionID" -Value "Professional" -PropertyType String -Force -ErrorAction SilentlyContinue

      - name: Configure Windows RDP Settings
        run: |
          # Enable RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "SecurityLayer" -Value 0 -Force

          # Configure firewall rules
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          netsh advfirewall firewall add rule name="RDP-Tailscale" `
            dir=in action=allow protocol=TCP localport=3389

          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "MaxInstanceCount" -Value 4294967295 -Force

          # Restart RDP services
          Restart-Service -Name TermService -Force
          Restart-Service -Name SessionEnv -Force

      - name: Create RDP User razzdev with Secure Password
        run: |
          # Remove existing user if exists
          $existingUser = Get-LocalUser -Name "razzdev" -ErrorAction SilentlyContinue
          if ($existingUser) {
              Remove-LocalUser -Name "razzdev"
          }

          # Generate secure password
          Add-Type -AssemblyName System.Security
          $charSet = @{
              Upper   = [char[]](65..90)
              Lower   = [char[]](97..122)
              Number  = [char[]](48..57)
              Special = ([char[]](33..47) + [char[]](58..64) +
                         [char[]](91..96) + [char[]](123..126))
          }
          $rawPassword = @()
          $rawPassword += $charSet.Upper | Get-Random -Count 4
          $rawPassword += $charSet.Lower | Get-Random -Count 4
          $rawPassword += $charSet.Number | Get-Random -Count 4
          $rawPassword += $charSet.Special | Get-Random -Count 4
          $password = -join ($rawPassword | Sort-Object { Get-Random })
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force

          # Create user razzdev
          New-LocalUser -Name "razzdev" -Password $securePass -AccountNeverExpires -FullName "Razz Development User"
          Add-LocalGroupMember -Group "Administrators" -Member "razzdev"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "razzdev"
          Set-LocalUser -Name "razzdev" -PasswordNeverExpires $true
          
          # Store credentials
          echo "RDP_CREDS=User: razzdev | Password: $password" >> $env:GITHUB_ENV
          echo "RDP_USERNAME=razzdev" >> $env:GITHUB_ENV
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          
          if (-not (Get-LocalUser -Name "razzdev")) {
              Write-Error "User creation failed"
              exit 1
          }
          Write-Host "User 'razzdev' created successfully"

      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"

          Write-Host "üì• Downloading Tailscale..."
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          
          Write-Host "üîß Installing Tailscale..."
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force

          Start-Sleep -Seconds 10
          Write-Host "‚úÖ Tailscale installation completed"

      - name: Start Tailscale Service
        run: |
          Write-Host "üöÄ Starting Tailscale service..."
          Start-Service -Name "Tailscale" -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 5
          
          $service = Get-Service -Name "Tailscale" -ErrorAction SilentlyContinue
          if ($service.Status -ne "Running") {
              Write-Host "‚ö†Ô∏è Tailscale service not running, attempting to start..."
              Start-Service -Name "Tailscale" -Force
              Start-Sleep -Seconds 3
          }
          Write-Host "‚úÖ Tailscale service started"

      - name: Fast Tailscale Authentication
        run: |
          Write-Host "‚ö° FAST AUTHENTICATION - Starting Tailscale connection..."
          
          if (-not (Test-Path "$env:ProgramFiles\Tailscale\tailscale.exe")) {
              Write-Error "‚ùå Tailscale not found in Program Files"
              exit 1
          }

          Write-Host "‚úÖ Tailscale executable found"
          Write-Host "üîë Authenticating with Tailscale..."
          
          # Direct execution without process overhead
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=win11-pro-razzdev --accept-routes --accept-dns --timeout=10s
          
          Write-Host "‚úÖ Authentication command executed"

      - name: Quick IP Retrieval
        run: |
          Write-Host "üîç Quickly retrieving Tailscale IP..."
          
          $tsIP = $null
          $maxQuickRetries = 5
          
          for ($i = 1; $i -le $maxQuickRetries; $i++) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>&1
              
              if ($LASTEXITCODE -eq 0 -and $tsIP -and $tsIP -notlike "*error*" -and $tsIP -match '^\d+\.\d+\.\d+\.\d+$') {
                  Write-Host "‚úÖ Tailscale IP obtained on attempt $i: $tsIP"
                  echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
                  break
              }
              
              Write-Host "‚è≥ Attempt $i/$maxQuickRetries - Waiting for IP..."
              Start-Sleep -Seconds 2
          }
          
          if (-not $env:TAILSCALE_IP) {
              Write-Host "‚ùå Failed to get Tailscale IP"
              exit 1
          }

      - name: Display Custom System Info
        run: |
          Write-Host ""
          Write-Host "================================================"
          Write-Host "üñ•Ô∏è  CUSTOM SYSTEM SPECIFICATIONS"
          Write-Host "================================================"
          Write-Host "Device Name: WIN11-PRO-RDP"
          Write-Host "Processor: Intel Xeon Platinum 8380 (2.3 GHz)"
          Write-Host "Installed RAM: 32.0 GB"
          Write-Host "Storage: 250 GB NVMe SSD"
          Write-Host "System Type: 64-bit operating system, x64-based processor"
          Write-Host "Edition: Windows 11 Pro"
          Write-Host "Version: 23H2"
          Write-Host "OS Build: 22631.2500"
          Write-Host "================================================"
          Write-Host "Note: This is a virtual environment for development"
          Write-Host "================================================"
          Write-Host ""

      - name: Display Connection Info
        run: |
          Write-Host ""
          Write-Host "================================================"
          Write-Host "üöÄ WINDOWS 11 PRO RDP READY"
          Write-Host "================================================"
          Write-Host "IP Address: $env:TAILSCALE_IP"
          Write-Host "Username: razzdev" 
          Write-Host "Password: $env:RDP_PASSWORD"
          Write-Host "================================================"
          Write-Host "To connect:"
          Write-Host "1. Install Tailscale on your device"
          Write-Host "2. Use Microsoft Remote Desktop"
          Write-Host "3. Connect to: $env:TAILSCALE_IP"
          Write-Host "4. Username: razzdev"
          Write-Host "5. Password: $env:RDP_PASSWORD"
          Write-Host "================================================"
          Write-Host ""

      - name: Maintain Session
        run: |
          Write-Host "üîÑ RDP session active - Cancel workflow to terminate"
          Write-Host "üìç IP: $env:TAILSCALE_IP"
          Write-Host "üë§ Username: razzdev"
          Write-Host "üîë Password: $env:RDP_PASSWORD"
          Write-Host ""
          Write-Host "üíª Virtual Specifications:"
          Write-Host "   - Intel Xeon Processor"
          Write-Host "   - 32GB RAM" 
          Write-Host "   - 250GB Storage"
          Write-Host "   - Windows 11 Pro"
          
          while ($true) {
              $timestamp = Get-Date -Format "HH:mm:ss"
              Write-Host "[$timestamp] RDP Active - razzdev@$env:TAILSCALE_IP"
              Start-Sleep -Seconds 300
          }
